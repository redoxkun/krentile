/**
 * Copyright (c) 2014 Albert Murciego Rico
 * 
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 * 
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 * 
 * 1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 * 2. Altered source versions must be plainly marked as such, and must not be
 *    misrepresented as being the original software.
 * 3. This notice may not be removed or altered from any source distribution.
 */

import 'dart:async';
import 'dart:html';
import 'dart:math';

import 'package:krentile/krentile.dart';

void main() {
  Game game = new Game();
  game.main();
}

class Game {
  
  Krentile _krentile;
  Alex _alex;
  List<Scorpion> _scorpions;
  
  int _fpsTextObjectIndex;

  bool _downPressed = false;
  bool _upPressed = false;
  bool _rightPressed = false;
  bool _leftPressed = false;

  static final int KEY_CODE_LEFT = 37;
  static final int KEY_CODE_UP = 38;
  static final int KEY_CODE_RIGHT = 39;
  static final int KEY_CODE_DOWN = 40;
  
  bool _replaceCanvas = false;
  CanvasElement _canvas;
  
  void main() {
    
    document.onKeyDown.listen((KeyboardEvent event) {
      if (event.keyCode == KEY_CODE_LEFT) {
        _leftPressed = true;
      } else if (event.keyCode == KEY_CODE_UP) {
        _upPressed = true;
      } else if (event.keyCode == KEY_CODE_RIGHT) {
        _rightPressed = true;
      } else if (event.keyCode == KEY_CODE_DOWN) {
        _downPressed = true;
      }
    });
    
    document.onKeyUp.listen((KeyboardEvent event) {
      if (event.keyCode == KEY_CODE_LEFT) {
        _leftPressed = false;
      } else if (event.keyCode == KEY_CODE_UP) {
        _upPressed = false;
      } else if (event.keyCode == KEY_CODE_RIGHT) {
        _rightPressed = false;
      } else if (event.keyCode == KEY_CODE_DOWN) {
        _downPressed = false;
      }
    });
    
    _canvas = querySelector("#webgl-canvas");
    _canvas.width = 960;
    _canvas.height = 720;
    
    initKrentile();
  }
  
  static final int UP_MAX = 64;
  int _upDistance;
  
  void resetCanvas() {
    _canvas = new CanvasElement();
    _canvas.id = "webgl-canvas";
    _canvas.width = 960;
    _canvas.height = 720;
    _replaceCanvas = true;
  }
  
  void initKrentile() {
    
    String baseUrl = getBaseUrl();
    
    _krentile = new Krentile(_canvas, baseUrl);

    String scene = '''
    {
      "version":"1.0",
      "width":320,
      "height":240,
      "camera":[160, 120],
      "backgroundColor":[0.0, 0.0, 1.0],
      "tileSize":8,
      "eventMap":[[ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                  [ 1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1],
                  [ 1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1],
                  [ 1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1],
                  [ 1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1],
                  [ 1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1],
                  [ 1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1],
                  [ 1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  0,  0,  0,  1,  1],
                  [ 1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  0,  0,  0,  1,  1],
                  [ 1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1],
                  [ 1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1],
                  [ 1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1],
                  [ 1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1],
                  [ 1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1],
                  [ 1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1]],
      "layers":[
          {
            "speedX":0.5,
            "speedY":1.0,
            "tilemap":[[ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  1,  2,  5,  6,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  5,  6,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  5,  6,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  5,  6,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  3,  4,  7,  8,  0,  0,  0,  0,  0,  1,  2,  5,  6,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  3,  4,  7,  8,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  3,  4,  7,  8,  0,  0,  0,  0,  0,  1,  2,  5,  6,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  3,  4,  7,  8,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  3,  4,  7,  8,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  5,  6,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  3,  4,  7,  8,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  5,  6,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  5,  6,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  3,  4,  7,  8,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  2,  5,  6,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  3,  4,  7,  8,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  3,  4,  7,  8,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  3,  4,  7,  8,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0]],
            "tileSize":8,
            "tileSet":"alexkiddtest1.png",
            "objects":[]
          },
          {
            "speedX":1.0,
            "speedY":1.0,
            "tilemap":[[ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [ 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
                       [13, 14,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 13, 14],
                       [15, 16,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 15, 16],
                       [13, 14,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 13, 14,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 13, 14],
                       [15, 16,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 15, 16,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 15, 16],
                       [13, 14,  0,  0,  0,  0,  0,  0,  0,  0, 13, 14,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 13, 14,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 13, 14],
                       [15, 16,  0,  0,  0,  0,  0,  0,  0,  0, 15, 16,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 15, 16,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 15, 16],
                       [13, 14,  0,  0,  0,  0,  0,  0,  0,  0, 13, 14,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 13, 14,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 13, 14,  0,  0,  0,  0,  0,  0,  0,  0,  0, 13, 14, 13, 14,  0,  0,  0, 13, 14],
                       [15, 16,  0,  0,  0,  0,  0,  0,  0,  0, 15, 16,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 15, 16,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 15, 16,  0,  0,  0,  0,  0,  0,  0,  0,  0, 15, 16, 15, 16,  0,  0,  0, 15, 16],
                       [ 9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10],
                       [11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12],
                       [ 9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10],
                       [11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12],
                       [ 9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10,  9, 10],
                       [11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12, 11, 12]],
            "tileSize":8,
            "tileSet":"alexkiddtest1.png",
            "objects":[2, 3]
          },
          {
            "speedX":1.0,
            "speedY":1.0,
            "tilemap":[[]],
            "tileSize":8,
            "tileSet":"alexkiddtest1.png",
            "objects":[0, 1]
          },
          {
            "speedX":0.0,
            "speedY":0.0,
            "tilemap":[[]],
            "tileSize":8,
            "tileSet":"alexkiddtest1.png",
            "objects":[]
          }
        ],
      "tileSets":[
          {
            "image":"alexkiddtest1.png",
            "width":128,
            "height":128,
            "tiles":[
                      {"left":120, "top":0,  "right":128, "bottom":8},
                      {"left":0,   "top":0,  "right":8,   "bottom":8},
                      {"left":8,   "top":0,  "right":16,  "bottom":8},
                      {"left":16,  "top":0,  "right":24,  "bottom":8},
                      {"left":24,  "top":0,  "right":32,  "bottom":8},
                      {"left":32,  "top":0,  "right":40,  "bottom":8},
                      {"left":40,  "top":0,  "right":48,  "bottom":8},
                      {"left":48,  "top":0,  "right":56,  "bottom":8},
                      {"left":56,  "top":0,  "right":64,  "bottom":8},
                      {"left":64,  "top":8,  "right":72,  "bottom":16},
                      {"left":72,  "top":8,  "right":80,  "bottom":16},
                      {"left":80,  "top":8,  "right":88,  "bottom":16},
                      {"left":88,  "top":8,  "right":96,  "bottom":16},
                      {"left":64,  "top":0,  "right":72,  "bottom":8},
                      {"left":72,  "top":0,  "right":80,  "bottom":8},
                      {"left":80,  "top":0,  "right":88,  "bottom":8},
                      {"left":88,  "top":0,  "right":96,  "bottom":8},
                      {"left":64,  "top":48, "right":72,  "bottom":56},
                      {"left":72,  "top":48, "right":80,  "bottom":56},
                      {"left":80,  "top":48, "right":88,  "bottom":56},
                      {"left":88,  "top":48, "right":96,  "bottom":56},

                      {"left":40,  "top":40, "right":48,  "bottom":48},
                      {"left":48,  "top":40, "right":56,  "bottom":48},
                      {"left":56,  "top":40, "right":64,  "bottom":48},

                      {"left":64,  "top":40, "right":72,  "bottom":48},
                      {"left":72,  "top":40, "right":80,  "bottom":48},
                      {"left":80,  "top":40, "right":88,  "bottom":48},

                      {"left":48,  "top":40, "right":40,  "bottom":48},
                      {"left":56,  "top":40, "right":48,  "bottom":48},
                      {"left":64,  "top":40, "right":56,  "bottom":48},

                      {"left":72,  "top":40, "right":64,  "bottom":48},
                      {"left":80,  "top":40, "right":72,  "bottom":48},
                      {"left":88,  "top":40, "right":80,  "bottom":48}
                    ]
          },
          {
            "image":"alexkiddtest2.png",
            "width":128,
            "height":128,
            "tiles":[
                      {"left":32,  "top":32, "right":40,  "bottom":40},
                      {"left":40,  "top":32, "right":48,  "bottom":40},
                      {"left":48,  "top":56, "right":56,  "bottom":64},
                      {"left":56,  "top":56, "right":64,  "bottom":64},
                      {"left":64,  "top":56, "right":72,  "bottom":64},
                      {"left":72,  "top":56, "right":80,  "bottom":64},

                      {"left":80,  "top":24, "right":88,  "bottom":32},
                      {"left":88,  "top":24, "right":96,  "bottom":32},
                      {"left":16,  "top":56, "right":24,  "bottom":64},
                      {"left":24,  "top":56, "right":32,  "bottom":64},
                      {"left":32,  "top":56, "right":40,  "bottom":64},
                      {"left":40,  "top":56, "right":48,  "bottom":64},

                      {"left": 0,  "top":  0, "right": 8, "bottom":8},
                      {"left": 8,  "top":  0, "right":16, "bottom":8},
                      {"left":16,  "top":  0, "right":24, "bottom":8},
                      {"left":24,  "top":  0, "right":32, "bottom":8},
                      {"left": 0,  "top":120, "right": 8, "bottom":128},
                      {"left": 8,  "top":120, "right":16, "bottom":128},

                      {"left":40,  "top":  0, "right":48, "bottom":8},
                      {"left":48,  "top":  0, "right":56, "bottom":8},
                      {"left":56,  "top":  0, "right":64, "bottom":8},
                      {"left":64,  "top":  0, "right":72, "bottom":8},

                      {"left":72,  "top":  0, "right": 80, "bottom":8},
                      {"left":80,  "top":  0, "right": 88, "bottom":8},
                      {"left":88,  "top":  0, "right": 96, "bottom":8},
                      {"left":96,  "top":  0, "right":104, "bottom":8},

                      {"left":104, "top":  0, "right":112, "bottom":8},
                      {"left":112, "top":  0, "right":120, "bottom":8},
                      {"left":120, "top":  0, "right":128, "bottom":8},
                      {"left":  0, "top":  8, "right":  8, "bottom":16},
                      {"left": 16, "top":120, "right": 24, "bottom":128},
                      {"left": 24, "top":120, "right": 32, "bottom":128},

                      {"left":16,  "top":  8, "right":24,  "bottom":16},
                      {"left":24,  "top":  8, "right":32,  "bottom":16},
                      {"left":32,  "top":  8, "right":40,  "bottom":16},
                      {"left":40,  "top":  8, "right":48,  "bottom":16},

                      {"left":48,  "top":  8, "right":56, "bottom":16},
                      {"left":56,  "top":  8, "right":64, "bottom":16},
                      {"left":64,  "top":  8, "right":72, "bottom":16},
                      {"left":72,  "top":  8, "right":80, "bottom":16},

                      {"left": 32, "top":120, "right": 40, "bottom":128},
                      {"left": 40, "top":120, "right": 48, "bottom":128},
                      {"left": 80, "top": 40, "right": 88, "bottom":48},
                      {"left": 88, "top": 40, "right": 96, "bottom":48},
                      {"left": 96, "top": 40, "right":104, "bottom":48},
                      {"left":104, "top": 40, "right":112, "bottom":48},

                      {"left":112, "top": 40, "right":120, "bottom":48},
                      {"left":120, "top": 40, "right":128, "bottom":48},
                      {"left":  0, "top": 48, "right":  8, "bottom":56},
                      {"left":  8, "top": 48, "right": 16, "bottom":56},

                      {"left":120, "top": 56, "right":128, "bottom":64},
                      {"left":  0, "top": 64, "right":  8, "bottom":72},
                      {"left":  8, "top": 64, "right": 16, "bottom":72},
                      {"left": 16, "top": 64, "right": 24, "bottom":72},
                      {"left": 24, "top": 64, "right": 32, "bottom":72},
                      {"left": 32, "top": 64, "right": 40, "bottom":72},

                      {"left": 40, "top": 64, "right": 48, "bottom":72},
                      {"left": 48, "top": 64, "right": 56, "bottom":72},
                      {"left": 56, "top": 64, "right": 64, "bottom":72},
                      {"left": 64, "top": 64, "right": 72, "bottom":72},

                      {"left": 72, "top": 64, "right": 80, "bottom":72},
                      {"left": 80, "top": 64, "right": 88, "bottom":72},
                      {"left": 88, "top": 64, "right": 96, "bottom":72},
                      {"left": 96, "top": 64, "right":104, "bottom":72}

                    ]
          },
          {
            "image":"alexkiddtest3.png",
            "width":128,
            "height":128,
            "tiles":[
                      {"left":  0,  "top": 0, "right":  8, "bottom": 8},
                      {"left":  8,  "top": 0, "right": 16, "bottom": 8},
                      {"left": 16,  "top": 0, "right": 24, "bottom": 8},
                      {"left": 24,  "top": 0, "right": 32, "bottom": 8},
                      {"left": 32,  "top": 0, "right": 40, "bottom": 8},
                      {"left": 40,  "top": 0, "right": 48, "bottom": 8},
                      {"left": 48,  "top": 0, "right": 56, "bottom": 8},
                      {"left": 56,  "top": 0, "right": 64, "bottom": 8},
                      {"left": 64,  "top": 0, "right": 72, "bottom": 8},
                      {"left": 72,  "top": 0, "right": 80, "bottom": 8},
                      {"left": 80,  "top": 0, "right": 88, "bottom": 8},
                      {"left": 88,  "top": 0, "right": 96, "bottom": 8},
                      {"left": 96,  "top": 0, "right":104, "bottom": 8},
                      {"left":104,  "top": 0, "right":112, "bottom": 8},
                      {"left":112,  "top": 0, "right":120, "bottom": 8},
                      {"left":120,  "top": 0, "right":128, "bottom": 8},

                      {"left":  0,  "top": 8, "right":  8, "bottom":16},
                      {"left":  8,  "top": 8, "right": 16, "bottom":16},
                      {"left": 16,  "top": 8, "right": 24, "bottom":16},
                      {"left": 24,  "top": 8, "right": 32, "bottom":16},
                      {"left": 32,  "top": 8, "right": 40, "bottom":16},
                      {"left": 40,  "top": 8, "right": 48, "bottom":16},
                      {"left": 48,  "top": 8, "right": 56, "bottom":16},
                      {"left": 56,  "top": 8, "right": 64, "bottom":16},
                      {"left": 64,  "top": 8, "right": 72, "bottom":16},
                      {"left": 72,  "top": 8, "right": 80, "bottom":16},
                      {"left": 80,  "top": 8, "right": 88, "bottom":16},
                      {"left": 88,  "top": 8, "right": 96, "bottom":16},
                      {"left": 96,  "top": 8, "right":104, "bottom":16},
                      {"left":104,  "top": 8, "right":112, "bottom":16},
                      {"left":112,  "top": 8, "right":120, "bottom":16},
                      {"left":120,  "top": 8, "right":128, "bottom":16},

                      {"left":  0,  "top":16, "right":  8, "bottom":24},
                      {"left":  8,  "top":16, "right": 16, "bottom":24},
                      {"left": 16,  "top":16, "right": 24, "bottom":24},
                      {"left": 24,  "top":16, "right": 32, "bottom":24},
                      {"left": 32,  "top":16, "right": 40, "bottom":24},
                      {"left": 40,  "top":16, "right": 48, "bottom":24},
                      {"left": 48,  "top":16, "right": 56, "bottom":24},
                      {"left": 56,  "top":16, "right": 64, "bottom":24},
                      {"left": 64,  "top":16, "right": 72, "bottom":24},
                      {"left": 72,  "top":16, "right": 80, "bottom":24},
                      {"left": 80,  "top":16, "right": 88, "bottom":24},
                      {"left": 88,  "top":16, "right": 96, "bottom":24},
                      {"left": 96,  "top":16, "right":104, "bottom":24},
                      {"left":104,  "top":16, "right":112, "bottom":24},
                      {"left":112,  "top":16, "right":120, "bottom":24},
                      {"left":120,  "top":16, "right":128, "bottom":24},

                      {"left":  0,  "top":24, "right":  8, "bottom":32},
                      {"left":  8,  "top":24, "right": 16, "bottom":32},
                      {"left": 16,  "top":24, "right": 24, "bottom":32},
                      {"left": 24,  "top":24, "right": 32, "bottom":32},
                      {"left": 32,  "top":24, "right": 40, "bottom":32},
                      {"left": 40,  "top":24, "right": 48, "bottom":32},
                      {"left": 48,  "top":24, "right": 56, "bottom":32},
                      {"left": 56,  "top":24, "right": 64, "bottom":32},
                      {"left": 64,  "top":24, "right": 72, "bottom":32},
                      {"left": 72,  "top":24, "right": 80, "bottom":32},
                      {"left": 80,  "top":24, "right": 88, "bottom":32},
                      {"left": 88,  "top":24, "right": 96, "bottom":32},
                      {"left": 96,  "top":24, "right":104, "bottom":32},
                      {"left":104,  "top":24, "right":112, "bottom":32},
                      {"left":112,  "top":24, "right":120, "bottom":32},
                      {"left":120,  "top":24, "right":128, "bottom":32}
                    ]
          }
        ],
      "objects":[
          {"type":0, "x":24,  "y":176, "visible":true, "initialState":0, "drawsToAdvanceFrame":4},
          {"type":2, "x":272, "y":184, "visible":true, "initialState":0, "drawsToAdvanceFrame":8},
          {"type":1, "x":80,  "y":152, "visible":true, "initialState":0, "drawsToAdvanceFrame":1},
          {"type":1, "x":208, "y":184, "visible":true, "initialState":0, "drawsToAdvanceFrame":1}
        ],
      "objectTypes":[
          {
            "tileSet":"alexkiddtest2.png",
            "tilemaps":[[[ 0,  1],
                         [ 2,  3],
                         [ 4,  5]],

                        [[ 6,  7],
                         [ 8,  9],
                         [10, 11]],

                        [[12, 13],
                         [14, 15],
                         [16, 17]],
                        [[12, 13],
                         [18, 19],
                         [20, 21]],
                        [[12, 13],
                         [22, 23],
                         [24, 25]],

                        [[26, 27],
                         [28, 29],
                         [30, 31]],
                        [[26, 27],
                         [32, 33],
                         [34, 35]],
                        [[26, 27],
                         [36, 37],
                         [38, 39]],

                        [[40, 41],
                         [42, 43],
                         [44, 45]],

                        [[26, 27],
                         [46, 47],
                         [48, 49]],

                        [[50, 51],
                         [52, 53],
                         [54, 55]],
                        [[50, 51],
                         [56, 57],
                         [58, 59]],
                        [[50, 51],
                         [60, 61],
                         [62, 63]]],
            "states":[[0],
                      [1],
                      [2, 3, 4],
                      [5, 6, 7],
                      [8],
                      [9],
                      [10, 11, 12]],
            "tileSize":8
          },
          {
            "tileSet":"alexkiddtest1.png",
            "tilemaps":[[[17, 18],
                         [19, 20]]],
            "states":[[0]],
            "tileSize":8
          },
          {
            "tileSet":"alexkiddtest1.png",
            "tilemaps":[[[ 0, 21],
                         [22, 23]],
                        [[ 0, 24],
                         [25, 26]],

                        [[27,  0],
                         [29, 28]],
                        [[30,  0],
                         [32, 31]]],
            "states":[[0, 1],
                      [2, 3]],
            "tileSize":8
          }
        ]
    }
    ''';
    
    Future future = _krentile.loadSceneFromString(scene);
    
    future.then((_) {
      _alex = new Alex(_krentile.getObject(0));
      _scorpions = new List<Scorpion>();
      _scorpions.add(new Scorpion(_krentile.getObject(1)));
      _scorpions[0].index = 1;
      
      _upDistance = 0;
      
      
      _krentile.addText(" TILE FONTS SUPPORT ", 32, 32, "alexkiddtest3.png", 2);
      _krentile.addText(" ADDED TO KRENTILE! ", 32, 40, "alexkiddtest3.png", 2);
      
      _fpsTextObjectIndex = _krentile.addText("FPS: 0", 256, 8, "alexkiddtest3.png", 3);
      
      _krentile.draw();
      
      if (_replaceCanvas) {
        CanvasElement canvas = querySelector("#webgl-canvas");
        canvas.replaceWith(_canvas);
        _replaceCanvas = false;
      }
      
      //window.requestAnimationFrame(draw);
      window.animationFrame.then(draw);
      /*new Future.delayed(const Duration(milliseconds:1), () {
        double t = new DateTime.now().millisecondsSinceEpoch.toDouble();
        draw(t);
      });*/
    });
  }
  
  int _second = -1;
  int _frames = 0;
  
  void draw(double time) {
    
    int currentSecond = (time / 1000.0).floor();
    if (currentSecond != _second) {
      _second = currentSecond;
      print('second: $_second frames: $_frames');
      _krentile.changeText(_fpsTextObjectIndex, 'FPS: $_frames');
      _frames = 0;
    }
    _frames++;
    
    if (currentSecond % 5 == 0) {
      // Add a new scorpion
      Random rnd = new Random();
      
      if (rnd.nextBool()) {
        SceneObject scorpionObject = new SceneObject.data(2, rnd.nextInt(512 - 17), rnd.nextInt(272), true, 0, 8);
        int index = _krentile.addObject(scorpionObject, 2);
        Scorpion scorpion = new Scorpion(scorpionObject);
        scorpion.index = index;
        _scorpions.add(scorpion);
      } else {
        if (_scorpions.length > 2) {
          _krentile.removeObject(_scorpions[0].index, 2);
          _scorpions.removeAt(0);
        }
      }
    }
    
    // Scorpion
    for (Scorpion scorpion in _scorpions) {
      if (scorpion.state == 0) {
        bool scorpionCollision = (_krentile.event(scorpion.x - 1, scorpion.y) == 1);
        if (scorpion.x > 0 && !scorpionCollision) {
          scorpion.x--;
        } else {
          scorpion.state = 1;
        }
      } else if (scorpion.state == 1) {
        bool scorpionCollision = (_krentile.event(scorpion.x + 17, scorpion.y) == 1);
        if (scorpion.x < (512 - 16) && !scorpionCollision) {
          scorpion.x++;
        } else {
          scorpion.state = 0;
        }
      }
    }

      // Alex
    if (_alex.state == 6) {
      _alex.y = _alex.y - 2;
      if (_alex.bottom == 0) {
        _krentile.cleanUp();
        resetCanvas();
        initKrentile();
        return;
      }
    } else {
      bool collisionDown = ((_krentile.event(_alex.x, _alex.y + 24) == 1) ||
                         (_krentile.event(_alex.x + 16, _alex.y + 24) == 1));
      
      if (_leftPressed) {
        if (_alex.state != 2 && collisionDown) {
          _upDistance = 0;
          _alex.state = 2;
        } else if (_alex.state != 4 && !collisionDown) {
          _alex.state = 4;
        }
        
        bool collision = ((_krentile.event(_alex.x - 1, _alex.y) == 1) ||
                         (_krentile.event(_alex.x - 1, _alex.y + 16) == 1));
        if (_alex.x > 0 && !collision) {
          _alex.x--;
  
          if (_krentile.cameraX > 160 && _alex.x < 352) {
            _krentile.cameraX--;
          }
        }
      }
      
      if (_rightPressed) {
        if (_alex.state != 3 && collisionDown) {
          _upDistance = 0;
          _alex.state = 3;
        } else if (_alex.state != 5 && !collisionDown) {
          _alex.state = 5;
        }
        
        bool collision = ((_krentile.event(_alex.x + 17, _alex.y) == 1) ||
                         (_krentile.event(_alex.x + 17, _alex.y + 16) == 1));
        if (_alex.x < (512 - 16) && !collision) {
          _alex.x++;
          
          if (_krentile.cameraX < 352 && _alex.x > 160) {
            _krentile.cameraX++;
          }
        }
      }
  
      if (_upPressed) {
        //_krentile.cameraY--;
        
        if (_upDistance < UP_MAX) {
          _alex.y = _alex.y - 2;
          _upDistance = _upDistance + 2;
          if (_alex.state == 2 || _alex.state == 1) {
            _alex.state = 4;
          } else if (_alex.state == 3 || _alex.state == 0) {
            _alex.state = 5;
          }
        }
      } else {
        if (collisionDown) {
          _upDistance = 0;
        } else {
          _upDistance = UP_MAX;
        }
      }
      
      if (!_leftPressed && !_rightPressed && !_upPressed) {
        if (collisionDown) {
          if (_alex.state == 2 || _alex.state == 4) {
            _upDistance = 0;
            _alex.state = 1;
          } else if (_alex.state == 3 || _alex.state == 5) {
            _upDistance = 0;
            _alex.state = 0;
          }
        } else {
          if (_alex.state == 2 || _alex.state == 1) {
            _upDistance = UP_MAX;
            _alex.state == 4;
          } else if (_alex.state == 3 || _alex.state == 0) {
            _upDistance = UP_MAX;
            _alex.state == 5;
          }
        }
      }
  
  
      if (_upDistance >= UP_MAX && !collisionDown) {
        _alex.y = _alex.y + 2;
      }
      

      for (Scorpion scorpion in _scorpions) {
        if (isCollision(_alex, scorpion)) {
          _alex.state = 6;
        }
      }
    }
    
    /*if (downPressed) {
      _krentile.cameraY++;
    }*/
    
    _krentile.draw();
    //window.requestAnimationFrame(draw);
    window.animationFrame.then(draw);
    /*new Future.delayed(const Duration(milliseconds:1), () {
      double t = new DateTime.now().millisecondsSinceEpoch.toDouble();
      draw(t);
    });*/
  }
  
  bool isCollision(Alex object1, Scorpion object2) {
    return ((((object1.left >= object2.left) && (object1.left <= object2.right)) ||
            ((object1.right >= object2.left) && (object1.right <= object2.right))) &&
            (((object1.top >= object2.top) && (object1.top <= object2.bottom)) || 
            ((object1.bottom >= object2.top) && (object1.bottom <= object2.bottom)))) ||
            ((((object2.left >= object1.left) && (object2.left <= object1.right)) ||
            ((object2.right >= object1.left) && (object2.right <= object1.right))) &&
            (((object2.top >= object1.top) && (object2.top <= object1.bottom)) || 
            ((object2.bottom >= object1.top) && (object2.bottom <= object1.bottom))));
  }
  
  static String getBaseUrl() {
    var location = window.location.href;
    return "${location.substring(0, location.length - "krentiletest.html".length)}";
  }
}

class Alex {
  
  SceneObject _object;
  
  Alex(this._object);
  
  int get x => _object.x;
  void set x(int x) {
    _object.x = x;
  }
  
  int get y => _object.y;
  void set y(int y) {
    _object.y = y;
  }
  
  int get state => _object.state;
  void set state(int state) {
    _object.state = state;
  }
  
  int get left => _object.x;
  int get top => _object.y;
  int get right => _object.x + 8 * 2;
  int get bottom => _object.y + 8 * 3;
}

class Scorpion {
  
  SceneObject _object;
  int _index;
  
  Scorpion(this._object);
  
  int get x => _object.x;
  void set x(int x) {
    _object.x = x;
  }
  
  int get y => _object.y;
  void set y(int y) {
    _object.y = y;
  }
  
  int get state => _object.state;
  void set state(int state) {
    _object.state = state;
  }
  
  int get left => _object.x;
  int get top => _object.y;
  int get right => _object.x + 8 * 2;
  int get bottom => _object.y + 8 * 2;
  
  SceneObject get object => _object;
  
  int get index => _index;
  void set index (int index) {
    _index = index;
  }
}

